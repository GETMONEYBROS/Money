define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","modules/core/i18n","spectrum/button","spectrum/popover","modules/clean/react/file_viewer/open_button/utils","modules/clean/file_store/utils","modules/clean/react/extensions/file","modules/clean/react/file_viewer/open_button/types","modules/clean/react/app_actions/telemetry_client","modules/clean/react/files_view/constants","spectrum/tertiary_link","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/app_actions/education/edu_tooltip_component","modules/clean/react/app_actions/apis","modules/clean/react/app_actions/data/selectors","modules/clean/react/app_actions/data/types","modules/clean/react/app_actions/extensions_popover_content_component","modules/clean/react/app_actions/data/action_creators","modules/clean/react/extensions/utils","modules/clean/cloud_docs/open_with_utils","modules/clean/react/extensions/tooltips","modules/clean/react/app_actions/shared_file_popover_content_component","modules/clean/react/bubble_dropdown_v2"],function(e,t,o,n,i,r,s,p,a,l,c,u,d,h,f,g,m,w,_,I,v,C,y,S,T,O,x,D,E,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=o.__importDefault(n);var F=(function(t){function i(e){var i=t.call(this,e)||this;return i.setActionMenuRef=function(e){i.actionMenuContent=e},i.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation(),i.setPopoverContentPosition()},i.handleHover=function(){i.currentSession&&i.currentSession.event("trigger_hover")},i.handlePreventMouseDown=function(e){e.preventDefault(),i.markBigTooltipViewed()},i.setBigTooltip=function(e){return o.__awaiter(i,void 0,void 0,function(){var t,n,i,r;return o.__generator(this,function(o){switch(o.label){case 0:return t=this.props.extensionsConfig.actionCategories.length>0,t||"CONTROL"===this.props.extensionsConfig.featureFlags.expSplitShareBtn?[4,v.getTooltipHistory(e,["open_with_edu","download_intercept_pdf"])]:[3,2];case 1:n=o.sent(),i=D.allowedTooltipsForConfig(this.props.extensionsConfig,u.getFileExt(this.props.file)||""),r=i.find(function(e){return void 0!==n[e]&&!n[e]}),this.setState({bigTooltipName:r}),o.label=2;case 2:return[2]}})})},i.markBigTooltipViewed=function(){var e=!1,t=[];return"download_intercept_pdf"===i.state.bigTooltipName?i.props.inDownloadInterceptFlow&&i.props.setInDownloadInterceptFlow&&(i.props.setInDownloadInterceptFlow({inDownloadInterceptFlow:!1}),e=!0):"upload_intercept_pdf"===i.state.bigTooltipName?i.props.setInUploadInterceptFlow&&i.props.uploadInterceptFlowFileId&&i.props.file.file_id===i.props.uploadInterceptFlowFileId&&(i.props.setInUploadInterceptFlow({uploadInterceptFlowFileId:void 0}),e=!0):i.state.bigTooltipName&&(t.push(v.markTooltipViewed(i.props.user.id,i.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then(function(){i.props.showBigTooltip&&i.setBigTooltip(i.props.user.id)}),i.setState({bigTooltipName:void 0})),e},i.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),i.logToPreviews(e,!1),t.stopPropagation(),e.userAction===w.UserAction.Download&&i.maybeShowDownloadIntercept()},i.logToPreviews=function(e,t){if(i.props.telemetryContext&&"previews"===i.props.telemetryContext.surface&&e.userAction){var o=t?w.UserActionContext.TitleBarMain:w.UserActionContext.TitleBarSplitButton,n=e.actionName?{app_action_name:e.actionName}:{};c.isBrowseFile(i.props.file)&&i.props.file.read_only&&(n.readOnly=!0),_.logUserAction(e.userAction,o,n)}},i.renderTrigger=function(){return i.props.triggerType===y.TriggerType.SidebarLink?n.default.createElement(g.TertiaryLink,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-link",icon:"open-with"},i.triggerText()):n.default.createElement(p.Button,{className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",variant:i.props.triggerType===y.TriggerType.SecondaryButton?"secondary":"primary",tagName:"span"},i.renderTriggerButtonContent())},i.renderMenu=function(e){var t=i.getEduTooltipExperimentConfig(i.state.bigTooltipName);return n.default.createElement("div",{className:"app-action-open-with-menu",ref:i.setActionMenuRef},n.default.createElement(a.Popover,{className:"app-action-open-with-menu__popover",onClick:i.handleButtonClick,onDoubleClick:i.handleButtonClick,onSelection:i.handleSelectAction,onMenuToggle:i.onPopoverToggle,closeOnSelection:!0},n.default.createElement(a.PopoverTrigger,null,n.default.createElement("div",{onMouseDown:i.handlePreventMouseDown,onMouseEnter:i.handleHover},i.renderTrigger())),n.default.createElement(a.PopoverContent,{position:i.state.popoverContentPosition,attachment:"right",height:i.state.height},i.renderExtensionPopoverContent(e))),t?n.default.createElement(I.ExtensionsTooltip,{userId:i.props.user.id,targetNode:i.actionMenuContent,title:t.tooltipTitle,message:t.tooltipMessage,logHistory:i.markBigTooltipViewed,position:"upload_intercept_pdf"===i.state.bigTooltipName?P.BubbleDropdownPositions.LEFT:void 0}):null)},i.onPopoverToggle=function(e){var t=e.isOpen;i.props.onDropdownOpen&&i.props.onDropdownClose&&(t?i.props.onDropdownOpen():i.props.onDropdownClose()),i.currentSession&&i.currentSession.event(t?"open_popover":"close_popover")},i.onDownloadClick=function(e){return function(t){t.preventDefault(),t.stopPropagation(),e.handler(),i.logToPreviews(e,!0)}},i.state={popoverContentPosition:"below"},i.telemetryClient=h.createTelemetryClient({component:"menu"}),i}return o.__extends(i,t),i.prototype.componentDidMount=function(){this.props.showBigTooltip?this.setBigTooltip(this.props.user.id):this.props.telemetryContext&&"sidebar"===this.props.telemetryContext.surface&&this.setState({bigTooltipName:"upload_intercept_pdf"})},i.prototype.includeDownloadInMenu=function(){return this.props.showAsButtonIfDownloadOnly},i.prototype.setPopoverContentPosition=function(){var e=this,t=this.actionMenuContent.getElementsByClassName("app-action-open-with-menu__trigger")[0],o=2*f.OverflowMenuConstants.MENU_MARGIN_PX,n=0,i=0,r=0,s=0,p=0,a=this.props,c=a.extensionsConfig,u=a.file,h=a.onPresentInZoom,g=a.refreshSharingServiceInfo,m=a.sharingServiceInfo;l.getOpenOptions({file:u,hasOpenInPaperSupport:!!this.props.hasOpenInPaperSupport,isOpenWithDisabled:!!this.props.isOpenWithDisabled,unityInfo:this.props.unityInfo||[],extraOptions:this.props.extraOptions,user:this.props.user,sharingServiceInfo:m,refreshSharingServiceInfo:g,showOpenWithShare:O.shouldShowOpenWithShare(c,u),onPresentInZoom:h,isCloudBasedDoc:x.isCloudBasedDoc(this.props.file)}).forEach(function(t){t.type===d.OpenButtonAction.OPEN_IN_PAPER?n=o+32:t.type===d.OpenButtonAction.OPEN_WITH||t.type===d.OpenButtonAction.OPEN_WITH_CLOUD_DOC?i=o+32:t.type===d.OpenButtonAction.UNITY_FILE||t.type===d.OpenButtonAction.UNITY_FOLDER?r=o:t.type===d.OpenButtonAction.DOWNLOAD&&e.includeDownloadInMenu()&&(s=o),(e.includeDownloadInMenu()||t.type!==d.OpenButtonAction.DOWNLOAD)&&(p+=40)}),p+=n+i+r+s,this.props.extensionsConfig.actionCategories.forEach(function(e){p+=40*e.actions.length+o+32});var w=t.getBoundingClientRect();w.top>p+132&&w.bottom+p+60>window.innerHeight?this.setState({popoverContentPosition:"above"}):(this.setState({popoverContentPosition:"below"}),this.props.telemetryContext&&"sidebar"===this.props.telemetryContext.surface&&this.setState({height:window.innerHeight-w.bottom-60}))},i.prototype.maybeShowDownloadIntercept=function(){return o.__awaiter(this,void 0,void 0,function(){var t,n,i;return o.__generator(this,function(r){switch(r.label){case 0:return[4,new Promise(function(t,o){e(["modules/clean/react/extensions/download_intercept"],t,o)}).then(o.__importStar)];case 1:return t=r.sent().onDownloadFile,n=u.getFileExt(this.props.file),i=this.props.setInDownloadInterceptFlow,n&&i&&t(this.props.extensionsConfig,this.props.user,n,function(){i({inDownloadInterceptFlow:!0})}),[2]}})})},i.prototype.triggerText=function(){return s._("Open with")},i.prototype.renderTriggerButtonContent=function(){var e=this.triggerText();return n.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},n.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},e+" â–¾"))},i.prototype.getEduTooltipExperimentConfig=function(e){switch(e){case"open_with_edu":var t=this.props.extensionsConfig.featureFlags.expSplitShareBtn;return t&&D.EduTooltipExperiment.EDU_SPLIT_SHARE_MAP[t]?D.EduTooltipExperiment.EDU_SPLIT_SHARE_MAP[t]:D.EduTooltipExperiment.TOOLTIP_CONFIGS[e];case"download_intercept_pdf":if(this.props.inDownloadInterceptFlow)return D.EduTooltipExperiment.TOOLTIP_CONFIGS[e];return;case"upload_intercept_pdf":if(this.props.uploadInterceptFlowFileId&&this.props.uploadInterceptFlowFileId===this.props.file.file_id)return D.EduTooltipExperiment.TOOLTIP_CONFIGS[e];return;default:return}},i.prototype.renderExtensionPopoverContent=function(e){return c.isBrowseFile(this.props.file)?n.default.createElement(S.ExtensionsPopoverContentWithUnity,{file:this.props.file,extensionsConfig:this.props.extensionsConfig,user:this.props.user,openOptions:e,showAsButtonIfDownloadOnly:this.props.showAsButtonIfDownloadOnly,appIcons:this.props.appIcons,refreshAppIcons:this.props.refreshAppIcons,updateLinkState:this.props.updateLinkState,currentSession:this.currentSession}):c.isSharedFile(this.props.file)?n.default.createElement(E.SharedFilePopoverContent,{openOptions:e}):null},i.prototype.render=function(){var e=this.props,t=e.file,o=e.extensionsConfig,i=e.onPresentInZoom,r=e.refreshSharingServiceInfo,a=e.sharingServiceInfo;if(!t.file_id)return null;this.props.telemetryContext?this.currentSession=this.telemetryClient.session({surface:this.props.telemetryContext.surface,ext:h.getPiiSafeExtension(u.getFileExt(t)||""),feature_flags:this.props.extensionsConfig.featureFlags}):delete this.currentSession;var c=l.getOpenOptions({file:t,hasOpenInPaperSupport:!!this.props.hasOpenInPaperSupport,isOpenWithDisabled:!!this.props.isOpenWithDisabled,unityInfo:this.props.unityInfo||[],extraOptions:this.props.extraOptions,user:this.props.user,sharingServiceInfo:a,refreshSharingServiceInfo:r,showOpenWithShare:O.shouldShowOpenWithShare(o,t),onPresentInZoom:i,isCloudBasedDoc:x.isCloudBasedDoc(this.props.file)}),f=c.length>0,g=!1;return f&&1===c.length&&(g=c[0].type===d.OpenButtonAction.DOWNLOAD,f=!g),0!==this.props.extensionsConfig.actionCategories.length||f?this.renderMenu(c):this.props.showAsButtonIfDownloadOnly&&g?n.default.createElement(p.Button,{className:"app-actions-download-button",variant:this.props.triggerType===y.TriggerType.SecondaryButton?"secondary":"primary",onClick:this.onDownloadClick(c[0])},s._("Download")):null},i.defaultProps={hasOpenInPaperSupport:!1,isOpenWithDisabled:!1,showAsButtonIfDownloadOnly:!1,triggerType:y.TriggerType.SecondaryButton,unityInfo:{}},i})(n.default.Component);t.ExtensionsMenuComponent=F,t.ExtensionsMenuWithUnityComponent=function(e){return c.isBrowseFile(e.file)?n.default.createElement(m.WithUnity,{file:e.file,user:e.user,render:function(t){return n.default.createElement(F,o.__assign({},e,{unityInfo:t}))}}):null};var B=function(e){return{appIcons:C.getAppIcons(e),sharingServiceInfo:C.sharingServiceInfo(e),inDownloadInterceptFlow:C.inDownloadInterceptFlow(e),uploadInterceptFlowFileId:C.uploadInterceptFlowFileId(e)}},b={refreshAppIcons:T.refreshAppIcons,updateLinkState:T.updateLinkState,refreshSharingServiceInfo:T.refreshSharingServiceInfo,setInDownloadInterceptFlow:T.setInDownloadInterceptFlow,setInUploadInterceptFlow:T.setInUploadInterceptFlow},A=i.connect(B,b)(t.ExtensionsMenuWithUnityComponent),N=i.connect(B,b)(F);t.ExtensionsMenuNoUnity=r.requireCssWithComponent(N,["/static/css/app_actions/index-vflHSvW_P.css"]),t.ExtensionsMenu=r.requireCssWithComponent(A,["/static/css/app_actions/index-vflHSvW_P.css"])});
//# sourceMappingURL=app_actions_menu_component.min.js-vflH1xcwb.map
define(["require","exports","tslib","react","classnames","spectrum_comments/thread","spectrum_comments/comment_stream/comment_stream_post_bar","spectrum_comments/comment","spectrum_comments/comment_editor/comment_utils","spectrum_comments/comment_editor/comment_editor","spectrum_comments/types","prop-types","spectrum_comments/comment_stream/unread_pill_wrapper","spectrum_comments/utils/calc_visibility_data","spectrum_comments/utils/visibility_aware_scroll_list","spectrum_comments/comment_editor/draft_utils","spectrum/tooltip","spectrum/icon_global","spectrum_comments/coachmark_location"],function(t,e,n,o,a,r,i,s,c,d,m,l,u,p,h,f,C,E,v){"use strict";function _(t,e){return t.map(function(t){return{item:t,ref:e[t.id]}}).filter(function(t){var e=t.item,n=t.ref;return!e.read&&n})}Object.defineProperty(e,"__esModule",{value:!0});var y=function(){},k=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.threadIdToRef={},e.editorHasChanges={},e.state={content:c.createEmptyContent(),editedComment:void 0,visibilityData:p.createEmptyVisibilityData(),trackedItems:[],coachmarkPositions:{location:null,target:null}},e.onThreadInteractedWith=function(t){var n=e.props,o=n.activeThreadID,a=n.collapsed,r=n.actionsAdapter,i=r.onThreadActivated,s=r.onInteractionWhileCollapsed;a&&s&&s(m.CollapsedInteraction.AVATAR_CLICK),o!==t.id&&i(t)},e.onVisibilityDataChange=function(t){e.setState({visibilityData:t})},e.updateTrackedItems=function(){e.setState({trackedItems:_(e.props.threads,e.threadIdToRef)})},e.createUpdateCoachmarkPosition=function(t){return function(o){e.setState(function(e){return{coachmarkPositions:n.__assign({},e.coachmarkPositions,(a={},a[t]=o,a))};var a})}},e.onStartEdit=function(t){e.setState({editedComment:t})},e.onEndEdit=function(){e.setState({editedComment:void 0})},e.onLeaveACommentClick=function(){var t=e.props,n=t.collapsed,o=t.actionsAdapter.onInteractionWhileCollapsed;n&&(o&&o(m.CollapsedInteraction.LEAVE_COMMENT_CLICK),e.focusPrimaryEditor())},e.setDraftRef=function(t){e.draftRef=t},e.setThreadRef=function(t,n){e.threadIdToRef[t]=n&&n.innerRef},e.handleClick=function(t){t.target.classList.contains("sc-comment-stream-threads")&&(e.props.actionsAdapter.onAllThreadsDeactivated(),e.editorHasChanges.PRIMARY||e.props.actionsAdapter.onCommentDraftCancel())},e.onThreadReplyCancel=function(){e.props.actionsAdapter.onAllThreadsDeactivated()},e.onPrimaryEditorCancel=function(){document.activeElement&&e.blurElement(document.activeElement),e.props.actionsAdapter.onCommentDraftCancel(),e.setState({content:c.createEmptyContent(),editedComment:void 0})},e.onPrimaryEditorFocus=function(){e.props.actionsAdapter.onAllThreadsDeactivated(),e.props.actionsAdapter.onEditorFocused()},e.onEditorStateChange=function(t){return function(n){e.editorHasChanges[t]=!f.contentIsEmpty(n)}},e.onPrimaryEditorStateChange=function(t){e.onEditorStateChange("PRIMARY")(t),e.props.actionsAdapter.onEditorStateChange(t)},e.hasUnsavedChanges=function(){var t=e.props.threads;return e.editorHasChanges.PRIMARY||t.some(function(t){return e.editorHasChanges[t.id]||!!t.pending})||void 0!==e.state.editedComment},e.promptBeforeCloseHandler=function(t){if(e.hasUnsavedChanges())return t.returnValue="",t.preventDefault(),""},e.createThreadActions=function(t){var n=e.props.actionsAdapter,o=n.onCommentDeleted,a=n.onCommentEdited,r=n.onClickTimeCode,i=n.onEditorFocused,s=n.onMentionsQueryUpdated,c=n.onThreadMarkedAsRead,d=n.onThreadMarkedAsUnread,m=n.onThreadRepliedTo,l=n.onThreadResolved,u=n.onThreadUnresolved,p=n.onThreadMouseEnter,h=void 0===p?y:p,f=n.onThreadMouseLeave,C=void 0===f?y:f,E=n.onClickOlderInfo,v=void 0===E?y:E;return{onClickTimeCode:r,onReply:function(e){return m(t,e)},onMarkAsRead:function(){return c(t)},onMarkAsUnread:function(){return d(t)},onResolve:function(){return l(t)},onUnresolve:function(){return u(t)},onMouseEnter:function(){return h(t)},onMouseLeave:function(){return C(t)},onEditorFocused:function(){return i(t)},onCommentDeleted:function(e){return o(e,t)},onCommentEdited:function(e,n){return a(e,n,t)},onMentionsQueryUpdated:s,onClickOlderInfo:v,onEditorStateChange:e.onEditorStateChange(t)}},e.renderPostBar=function(t){return o.createElement(i.CommentStreamPostBar,n.__assign({coachmarkTargetProps:e.createCoachmarkProps("target")},t))},e}return n.__extends(e,t),e.prototype.getChildContext=function(){return{localization:this.props.localization}},e.prototype.createCoachmarkProps=function(t){var e=this.props.coachmarkData||{component:function(){return null}};return n.__assign({},e,{updatePosition:this.createUpdateCoachmarkPosition(t),positions:this.state.coachmarkPositions})},e.prototype.componentDidMount=function(){window.addEventListener("beforeunload",this.promptBeforeCloseHandler),this.updateTrackedItems()},e.prototype.componentDidUpdate=function(t){this.props.threads!==t.threads&&this.updateTrackedItems()},e.prototype.componentWillUnmount=function(){window.removeEventListener("beforeunload",this.promptBeforeCloseHandler)},e.prototype.componentWillReceiveProps=function(t){t.coachmarkData!==this.props.coachmarkData&&this.setState({coachmarkPositions:{location:null,target:null}})},e.prototype.focusPrimaryEditor=function(){this.draftRef&&this.draftRef.focusEditor()},e.prototype.blurElement=function(t){var e;"function"==typeof Event?e=new FocusEvent("blur"):(e=document.createEvent("Event"),e.initEvent("blur",!0,!0)),t.dispatchEvent(e)},Object.defineProperty(e.prototype,"includeEditor",{get:function(){var t=this.props,e=t.isMobile;return t.settings.canShowEditor&&!e},enumerable:!0,configurable:!0}),e.prototype.render=function(){var t=this,e=this.props,i=e.actionsAdapter,c=i.onMentionsQueryUpdated,m=i.onThreadCreated,l=e.className,p=void 0===l?"":l,f=e.commentComponent,_=void 0===f?function(t){return o.createElement(s.Comment,n.__assign({},t))}:f,y=e.editorComponent,k=void 0===y?function(t){return o.createElement(d.CommentEditor,n.__assign({},t))}:y,T=e.enabled,g=e.user,P=e.mentionsMatches,A=e.activeThreadID,b=e.hoverThreadID,I=e.isMobile,M=e.threads,R=e.localization,D=e.collapsed,S=void 0!==D&&D,U=e.coachmarkData,L=e.settings,w=e.showRevisionInfo,W=a(p,{"sc-comment-stream":!0,"sc-comment-stream-enabled":T,"sc-comment-stream-all-changes-saved":!this.hasUnsavedChanges(),"sc-comment-stream-collapsed":S}),O=null,V=null;return this.includeEditor&&(O=k({author:g,className:"sc-comment-stream-editor",content:this.state.content,placeholder:R.streamEditorPlaceholder,postSignalComponent:this.renderPostBar,onCancel:this.onPrimaryEditorCancel,setDraftRef:this.setDraftRef,onPost:m,mentionsMatches:P,onMentionsQueryUpdated:c,onFocus:this.onPrimaryEditorFocus,onEditorStateChange:this.onPrimaryEditorStateChange})),S&&(V=o.createElement(C.Tooltip,{positioning:"left",tooltipContent:R.leaveACommentLabel},o.createElement(E.IconGlobal,{className:"sc-leave-a-comment-button",name:"comment",onClick:this.onLeaveACommentClick}))),o.createElement("div",{className:W,onClick:this.handleClick},V,O,U&&o.createElement(v.CoachmarkLocation,n.__assign({name:v.CoachmarkLocations.ABOVE_COMMENT_STREAM},this.createCoachmarkProps("location"),{positions:this.state.coachmarkPositions})),o.createElement(u.UnreadPillWrapper,{showUnreadPill:this.props.showUnreadPill,visibilityData:this.state.visibilityData,countMsgFn:R.unreadComments,onItemActivated:this.onThreadInteractedWith},o.createElement(h.VisibilityAwareScrollList,{className:"sc-comment-stream-threads",trackedItems:this.state.trackedItems,onVisibilityDataChange:this.onVisibilityDataChange},M.map(function(e){return o.createElement(r.Thread,{ref:function(n){return t.setThreadRef(e.id,n)},key:e.id,actions:t.createThreadActions(e.id),active:e.id===A,hover:e.id===b,commentComponent:_,editedComment:t.state.editedComment,onThreadInteractedWith:t.onThreadInteractedWith,onCancel:t.onThreadReplyCancel,onStartEdit:t.onStartEdit,onEndEdit:t.onEndEdit,isMobile:I,thread:e,user:g,mentionsMatches:P,showRevisionInfo:w,streamSettings:L})}))),U&&o.createElement(v.CoachmarkLocation,n.__assign({name:v.CoachmarkLocations.BELOW_COMMENT_STREAM},this.createCoachmarkProps("location"),{positions:this.state.coachmarkPositions})))},e.childContextTypes={localization:l.object},e})(o.PureComponent);e.CommentStream=k});
//# sourceMappingURL=comment_stream.min.js-vflxasXs2.map